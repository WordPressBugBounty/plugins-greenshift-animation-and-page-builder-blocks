const GS_SESSION_ID="uid-"+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,11);function GSrunAPICall(e){if("string"==typeof e&&(e=JSON.parse(e)),!e)return;function t(e,t){if(!t)return e;let r=t.match(/(\w+)|\[(\d+)\]/g);if(r)return r.reduce((e,t)=>(t=t.replace(/[\[\]]/g,""),e?e[t]:void 0),e)}let r=[{regex:/\{\{TEXT:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.innerText?t.innerText:""}},{regex:/\{\{VALUE:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.value?t.value:""}},{regex:/\{\{COOKIE:(.*?)\}\}/g,handler(e){let t;return GSCookClass.getCookie(e)||""}},{regex:/\{\{STORAGE:(.*?)\}\}/g,handler(e){let t;return localStorage.getItem(e)||""}},{regex:/\{\{ATTR:(.*?)\}\}/g,handler(e){let t=e.split("|").map(e=>e.trim());if(2===t.length){let r=t[0],l=document.querySelector(t[1]);return l&&l.getAttribute(r)||""}return""}},{regex:/\{\{FORMDATA:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);if(t){let r=new FormData(t),l={};return r.forEach((e,t)=>{l[t]=e}),JSON.stringify(l)}return""}},{regex:/\{\{SESSION_ID\}\}/g,handler:()=>GS_SESSION_ID}],l=e=>{if("string"!=typeof e)return e;let t=e;for(let{regex:l,handler:a}of r)t=t.replace(l,(e,t)=>a(t));return t},a=(e,t=!1)=>{if("string"!=typeof e)return e;let r=[],l=[],a=e.replace(/```([\s\S]*?)```/gim,function(e,t){let l=t,a="",n=l.match(/^([a-zA-Z0-9_+-]+)\s*\n/);return n&&(a=n[1].toLowerCase(),l=l.substring(n[0].length)),r.push({content:l,language:a}),"CODE_BLOCK_PLACEHOLDER_"+(r.length-1)});a=(a=(a=(a=(a=(a=(a=a.replace(/`(.*?)`/gim,function(e,t){return l.push(t),"INLINE_CODE_PLACEHOLDER_"+(l.length-1)})).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")).replace(/^### (.*$)/gim,"<h3>$1</h3>")).replace(/^## (.*$)/gim,"<h2>$1</h2>")).replace(/^# (.*$)/gim,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/gim,"<strong>$1</strong>")).replace(/\*(.*?)\*/gim,"<em>$1</em>");let n=!1,i="",s=a.split("\n");for(let o=0;o<s.length;o++){let c=s[o].match(/^\s*[\*\-] (.*)/),u=s[o].match(/^\s*(\d+)\. (.*)/);c?n&&"ul"===i?s[o]="<li>"+c[1]+"</li>":(n?s[o]="</"+i+"><ul><li>"+c[1]+"</li>":s[o]="<ul><li>"+c[1]+"</li>",n=!0,i="ul"):u?n&&"ul"===i?s[o]="<li>"+u[2]+"</li>":(n?s[o]="</"+i+"><ul><li>"+u[2]+"</li>":s[o]="<ul><li>"+u[2]+"</li>",n=!0,i="ul"):n&&""===s[o].trim()?(s[o]="</"+i+">",n=!1):n&&""!==s[o].trim()&&(s[o-1]=s[o-1].replace(/<\/li>$/," "+s[o]+"</li>"),s[o]="")}return n&&s.push("</"+i+">"),a=(a=s.join("\n")).replace(/\[(.*?)\]\((.*?)\)/gim,'<a href="$2">$1</a>'),t||(a=a.replace(/^(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+(?:\n(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+)*/gim,function(e){return""===e.trim()?"":"<p>"+e+"</p>"})),a=(a=(a=(a=(a=(a=(a=a.replace(/\n(?!\s*<\/?(?:p|ul|ol|li|h\d|blockquote|pre|code))/gim,"<br>")).replace(/<p>\s*<\/p>/gim,"")).replace(/CODE_BLOCK_PLACEHOLDER_(\d+)/g,function(e,t){let l=r[parseInt(t)],a=l.content,n=l.language;return(a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),n)?'<div class="code_language">'+n+"</div><pre><code>"+a+"</code></pre>":"<pre><code>"+a+"</code></pre>"})).replace(/INLINE_CODE_PLACEHOLDER_(\d+)/g,function(e,t){let r=l[parseInt(t)];return"<code>"+(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"))+"</code>"})).replace(/(<br>\s*)+/g,"<br>")).replace(/^\s*<br>/g,"")).replace(/<br>\s*$/g,"")},{result_selector:n,result_handle:i="replace",loader_selector:s,apiHeaders:o,apiUrl:c,apiMethod:u,apiBody:d,responseField:p,appendField:g,assistantField:f,user_message:h,assistant_message:m,custom_response:b,responseMaps:L,response_selector:S,repeatable:A,stream_chat:E=!1,stream_response:v=!1,no_data_text:y="No data found"}=e,$=Array.isArray(o)?o.reduce((e,t)=>(t.name&&(e[t.name]=l(t.value)),e),{}):{},_=s?document.querySelector(s):null;_&&_.classList.add("active");let T=n?document.querySelector(n):null;T&&(T.classList.remove("loaded"),T.classList.remove("active"),T.classList.add("loading"));let w="gspb-api-saved-var";p&&(w=p.replace(/[^a-zA-Z0-9]/g,""));let O=(e,r,l)=>{if(r&&e){let a=JSON.parse(e),n=t(a,r);n&&(Array.isArray(n)?n.push(l):a[r]=l),e=JSON.stringify(a)}return e},q=d?l(d):null;E&&void 0!==window[w]&&(q=window[w]);let H=h?l(h):null;H&&(q=O(q,g,JSON.parse(l(H)))),fetch(l(c),{method:u||"GET",headers:$,body:q}).then(e=>{if(v){if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);if(!e.body)throw Error("ReadableStream not supported in this browser.");let r=e.body.getReader(),l="",n=new TextDecoder,s=null;T&&("replace"===i&&(T.innerHTML=""),(s=document.createElement("div")).classList.add("gs-streaming-content"),"append"===i?T.appendChild(s):"prepend"===i?T.insertBefore(s,T.firstChild):T.appendChild(s));let o="",c=()=>r.read().then(({done:e,value:r})=>{if(e){s&&!s.classList.contains("result-loaded")&&s.classList.add("result-loaded");return}let a=n.decode(r,{stream:!0});l+=a;let i;if(b&&L&&S&&!s.hasAttribute("data-initialized")){let d=document.querySelector(S);d&&(s.innerHTML=d.innerHTML,s.setAttribute("data-initialized","true"))}let g=!s.hasAttribute("data-received-first-chunk");for(;-1!==(i=l.indexOf("\n"));){let h=l.slice(0,i).trim();if(l=l.slice(i+1),h&&s)try{if("data: [DONE]"===h){console.log("Stream completed"),s.classList.add("result-loaded");continue}let A=h.startsWith("data: ")?h.substring(6):h,E=JSON.parse(A),v=p?t(E,p):E;if(g&&_&&(_.classList.remove("active"),s.setAttribute("data-received-first-chunk","true"),g=!1),b&&L&&S){if(u(v),f&&m){let y=t(v,f);y&&(o+=y)}}else"string"==typeof v?(v=v.replace(/<\/?p>/g,""),s.innerHTML+=v):null!=v&&(s.innerHTML+=String(v)),m&&(o+=v)}catch($){console.error("Error parsing stream chunk:",$)}}return c()}),u=e=>{if(!b||!L||!S)return e;let r={};return L.forEach(l=>{let n=l.name,i=t(e,l.value);if(void 0===i)return;r[n]||(r[n]=s.querySelector(n));let o=r[n];if(o&&void 0!==i){if("date"===l.format&&(i=new Date(i).toLocaleString()),"markdown"===l.format&&"string"==typeof i){o.hasAttribute("data-raw-content")||o.setAttribute("data-raw-content","");let c=o.getAttribute("data-raw-content");c+=i,o.setAttribute("data-raw-content",c),o.innerHTML=a(c,!0)}else o.hasAttribute("src")?o.setAttribute("src",i):o.hasAttribute("href")?o.setAttribute("href",i):("string"==typeof i&&(i=i.replace(/<\/?p>/g,"")),o.innerHTML+=i)}}),null};return c().catch(e=>{throw console.error("Stream error:",e),e}).finally(()=>{if(T){T.classList.remove("loading"),setTimeout(()=>{T.classList.add("loaded"),T.classList.add("active")},50);let e=T.getAttribute("data-nextrun");if(e){let t=parseInt(e);T.setAttribute("data-nextrun",t+1)}else T.setAttribute("data-nextrun",2);s&&L&&L.forEach(e=>{if("markdown"===e.format){let t=s.querySelector(e.name);if(t&&t.hasAttribute("data-raw-content")){let r=t.getAttribute("data-raw-content");t.innerHTML=a(r,!0),t.removeAttribute("data-raw-content")}}})}if(q&&g&&o&&f&&m){let r=JSON.parse(m.replace("{{RESPONSE}}",o));q=O(q,g,r),window[w]=q}if(T){let l=T.querySelectorAll("[data-gspbactions]");l.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",l),"undefined"!=typeof GSChartRun&&GSChartRun(T),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:T,responseData:null}}))}})}return e.json()}).then(e=>{if(v)return;let r=p?t(e,p):e,l=r;if(f&&r&&q&&g&&m){let n=t(r,f),s=JSON.parse(m.replace("{{RESPONSE}}",n));q=O(q,g,s),window[w]=q}else window[w]=l;if(void 0===l&&(l='<div class="gspb-api-noresponse">'+y+"</div>"),b&&L&&S){let o=document.querySelector(S),c="",u=[];if(o){let d=e=>{let r=o.cloneNode(!0);return L.forEach(l=>{let n=l.name,i=t(e,l.value);void 0===i&&u.push(l.name);let s=r.querySelector(n);s&&void 0!==i&&("date"===l.format&&(i=new Date(i).toLocaleString()),"markdown"===l.format&&"string"==typeof i&&(i=a(i)),s.hasAttribute("src")?s.setAttribute("src",i):s.hasAttribute("href")?s.setAttribute("href",i):s.innerHTML=i)}),r.innerHTML};A&&Array.isArray(l)?l.forEach(e=>{c+=d(e)}):c=d(l),c&&(l=c),u.length>0&&u.length===L.length&&(l='<div class="gspb-api-noresponse">'+y+"</div>")}}if(T){"replace"===i?T.innerHTML=l:"append"===i?T.innerHTML+=l:"prepend"===i&&(T.innerHTML=l+T.innerHTML),Array.from(T.children).forEach(e=>{e.classList.contains("result-loaded")||setTimeout(()=>{e.classList.add("result-loaded")},10)});let h=T.querySelectorAll("[data-gspbactions]");h.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",h),"undefined"!=typeof GSChartRun&&GSChartRun(T),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:T,responseData:r}}))}}).catch(e=>{console.error("Fetch error:",e)}).finally(()=>{if(!v){if(_&&_.classList.remove("active"),T){T.classList.remove("loading"),setTimeout(()=>{T.classList.add("loaded"),T.classList.add("active")},50);let e=T.getAttribute("data-nextrun");if(e){let t=parseInt(e);T.setAttribute("data-nextrun",t+1)}else T.setAttribute("data-nextrun",2)}T&&T.querySelector(".gspb-api-noresponse")&&setTimeout(()=>{T.querySelector(".gspb-api-noresponse").remove()},1e3)}})}